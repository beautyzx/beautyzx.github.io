<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® åœˆåœˆäººå†’éšª</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: white; }
    #quest, #player, #controls { 
      position: absolute; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; border-radius: 10px; 
    }
    #quest { top: 10px; left: 10px; }
    #player { top: 100px; left: 10px; }
    #controls { bottom: 10px; left: 10px; font-size: 14px; }
    #inventory { 
      position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); 
      padding: 10px; border-radius: 10px; color: white; text-align: center; 
    }
    #inventory div { display: inline-block; margin: 5px; font-size: 16px; }
    #shop { 
      display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      background: #ffeb3b; padding: 20px; border-radius: 15px; text-align: center; 
    }
    #shop button { 
      background: #f44336; color: white; border: none; padding: 10px 20px; margin: 5px; 
      font-size: 16px; border-radius: 10px; cursor: pointer; 
    }
    #shop button:hover { background: #d32f2f; }
  </style>
</head>
<body>
  <div id="loading">ğŸ® è¼‰å…¥ä¸­...</div>
  <div id="quest">
    <h3>ğŸ¯ ä»»å‹™</h3>
    <p>æ”¶é›† 5 å€‹æœ¨é ­ <span id="wood-progress">(0/5)</span></p>
  </div>
  <div id="player">
    <p>ç­‰ç´š: <span id="level">1</span></p>
    <p>ç¶“é©—: <span id="exp">0/100</span></p>
    <p>é‡‘å¹£: <span id="gold">50</span></p>
  </div>
  <div id="controls">
    <p>æ“ä½œèªªæ˜:</p>
    <p>WASD - ç§»å‹•</p>
    <p>ç©ºç™½éµ - è·³èº</p>
    <p>æ»‘é¼ å·¦éµ - ç ´å£/æ”»æ“Š</p>
    <p>æ»‘é¼ å³éµ - æ”¾ç½®æ–¹å¡Š</p>
    <p>1-6 - é¸æ“‡ç‰©å“</p>
    <p>B - é–‹å•Ÿå•†åº—</p>
    <p>æ»‘é¼ ç§»å‹• - è½‰å‹•è¦–è§’</p>
  </div>
  <div id="inventory">
    <div>ğŸ§± <span id="brick">20</span></div>
    <div>ğŸŒ³ <span id="wood">0</span></div>
    <div>ğŸª¨ <span id="stone">0</span></div>
    <div>â›ï¸ <span id="pickaxe">1</span></div>
    <div>âš”ï¸ <span id="sword">1</span></div>
    <div>ğŸ– <span id="meat">3</span></div>
  </div>
  <div id="shop">
    <h2>ğŸª å•†åº—</h2>
    <div>
      <p>â›ï¸ éµé¬ (æŒ–æ˜é€Ÿåº¦+50%)<br>100 é‡‘å¹£</p>
      <button onclick="buyItem('pickaxe')">è³¼è²·</button>
    </div>
    <div>
      <p>âš”ï¸ éµåŠ (æ”»æ“ŠåŠ›+3)<br>150 é‡‘å¹£</p>
      <button onclick="buyItem('sword')">è³¼è²·</button>
    </div>
    <div>
      <p>ğŸ– çƒ¤è‚‰ (æ¢å¾©å¥åº·)<br>20 é‡‘å¹£</p>
      <button onclick="buyItem('meat')">è³¼è²·</button>
    </div>
    <div>
      <p>ğŸ§± çŸ³ç£š x10<br>30 é‡‘å¹£</p>
      <button onclick="buyItem('brick')">è³¼è²·</button>
    </div>
    <button onclick="closeShop()">é—œé–‰å•†åº—</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
  <script>
    // å ´æ™¯è¨­ç½®
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    document.getElementById('loading').style.display = 'none';

    // å…‰æº
    scene.add(new THREE.AmbientLight(0x404040));
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);

    // ç©å®¶æ§åˆ¶
    const controls = new THREE.PointerLockControls(camera, document.body);
    document.addEventListener('click', () => controls.lock());
    camera.position.set(0, 5, 10);
    scene.add(controls.getObject());

    // ç§»å‹•èˆ‡è·³èº
    const move = { forward: false, backward: false, left: false, right: false, jump: false };
    let velocity = new THREE.Vector3();
    let isOnGround = false;
    document.addEventListener('keydown', (e) => {
      if (e.key === 'w') move.forward = true;
      if (e.key === 's') move.backward = true;
      if (e.key === 'a') move.left = true;
      if (e.key === 'd') move.right = true;
      if (e.key === ' ') move.jump = true;
      if (e.key === 'b') document.getElementById('shop').style.display = 'block';
      if (e.key >= '1' && e.key <= '6') selectedItem = Object.keys(inventory)[parseInt(e.key) - 1];
    });
    document.addEventListener('keyup', (e) => {
      if (e.key === 'w') move.forward = false;
      if (e.key === 's') move.backward = false;
      if (e.key === 'a') move.left = false;
      if (e.key === 'd') move.right = false;
      if (e.key === ' ') move.jump = false;
    });

    // åœ°åœ–æ•¸æ“š
    const blocks = {};
    const blockSize = 1;
    const blockGeometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
    const grassMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
    const stoneMaterial = new THREE.MeshPhongMaterial({ color: 0x808080 });
    const woodMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 });
    const brickMaterial = new THREE.MeshPhongMaterial({ color: 0x696969 });
    const floatMaterial = new THREE.MeshPhongMaterial({ color: 0xff69b4 });

    // ç”Ÿæˆåœ°åœ–
    function generateMap() {
      // åœ°é¢
      for (let x = -10; x <= 10; x++) {
        for (let z = -10; z <= 10; z++) {
          const height = Math.floor(Math.random() * 3) + 1;
          addBlock(x, height, z, grassMaterial);
          for (let y = height - 1; y >= 0; y--) {
            addBlock(x, y, z, stoneMaterial);
          }
        }
      }
      // æ¨¹æœ¨
      for (let i = 0; i < 5; i++) {
        const x = Math.floor(Math.random() * 10 - 5);
        const z = Math.floor(Math.random() * 10 - 5);
        const height = Math.floor(Math.random() * 3) + 1;
        addBlock(x, height + 1, z, woodMaterial);
        addBlock(x, height + 2, z, grassMaterial); // æ¨¡æ“¬è‘‰å­
      }
      // æ¼‚æµ®å³¶å¶¼
      for (let i = 0; i < 4; i++) {
        const x = Math.floor(Math.random() * 10 - 5);
        const y = Math.floor(Math.random() * 5 + 10);
        const z = Math.floor(Math.random() * 10 - 5);
        addBlock(x, y, z, floatMaterial);
        addBlock(x + 1, y, z, floatMaterial);
      }
    }

    // æ·»åŠ æ–¹å¡Š
    function addBlock(x, y, z, material) {
      const block = new THREE.Mesh(blockGeometry, material);
      block.position.set(x * blockSize, y * blockSize, z * blockSize);
      scene.add(block);
      blocks[`${x},${y},${z}`] = { mesh: block, material };
    }

    // ç§»é™¤æ–¹å¡Š
    function removeBlock(x, y, z) {
      const key = `${x},${y},${z}`;
      if (blocks[key]) {
        const material = blocks[key].material;
        scene.remove(blocks[key].mesh);
        delete blocks[key];
        if (material === woodMaterial) {
          inventory.wood += 1;
          checkQuest();
        }
        if (material === stoneMaterial) inventory.stone += 1;
        updateUI();
      }
    }

    // å°„ç·šæŠ•å°„
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2(0, 0);
    function onMouseClick(event) {
      if (document.getElementById('shop').style.display === 'block') return;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(Object.values(blocks).map(b => b.mesh));
      if (intersects.length > 0) {
        const intersect = intersects[0];
        const pos = intersect.object.position;
        const x = Math.round(pos.x / blockSize);
        const y = Math.round(pos.y / blockSize);
        const z = Math.round(pos.z / blockSize);
        if (event.button === 0 && selectedItem === 'pickaxe') { // å·¦éµ + é¬å­
          removeBlock(x, y, z);
        } else if (event.button === 2 && selectedItem === 'brick' && inventory.brick > 0) { // å³éµ + çŸ³ç£š
          const normal = intersect.face.normal;
          addBlock(x + normal.x, y + normal.y, z + normal.z, brickMaterial);
          inventory.brick -= 1;
          updateUI();
        }
      }
    }
    document.addEventListener('mousedown', onMouseClick);

    // èƒŒåŒ…èˆ‡ç©å®¶æ•¸æ“š
    let inventory = { brick: 20, wood: 0, stone: 0, pickaxe: 1, sword: 1, meat: 3 };
    let player = { level: 1, exp: 0, gold: 50 };
    let selectedItem = 'pickaxe';
    function updateUI() {
      document.getElementById('brick').textContent = inventory.brick;
      document.getElementById('wood').textContent = inventory.wood;
      document.getElementById('stone').textContent = inventory.stone;
      document.getElementById('pickaxe').textContent = inventory.pickaxe;
      document.getElementById('sword').textContent = inventory.sword;
      document.getElementById('meat').textContent = inventory.meat;
      document.getElementById('level').textContent = player.level;
      document.getElementById('exp').textContent = `${player.exp}/100`;
      document.getElementById('gold').textContent = player.gold;
      document.getElementById('wood-progress').textContent = `(${inventory.wood}/5)`;
    }

    // ä»»å‹™
    function checkQuest() {
      if (inventory.wood >= 5) {
        player.exp += 50;
        player.gold += 20;
        document.getElementById('quest').innerHTML = '<h3>ğŸ¯ ä»»å‹™</h3><p>ä»»å‹™å®Œæˆï¼</p>';
        if (player.exp >= 100) {
          player.level += 1;
          player.exp -= 100;
        }
        updateUI();
      }
    }

    // å•†åº—
    function buyItem(item) {
      const prices = { pickaxe: 100, sword: 150, meat: 20, brick: 30 };
      if (player.gold >= prices[item]) {
        player.gold -= prices[item];
        if (item === 'brick') inventory.brick += 10;
        else inventory[item] += 1;
        updateUI();
        alert('è³¼è²·æˆåŠŸï¼');
      } else {
        alert('é‡‘å¹£ä¸è¶³ï¼');
      }
    }
    function closeShop() {
      document.getElementById('shop').style.display = 'none';
    }

    // ç”Ÿæˆåœ°åœ–
    generateMap();

    // æ¸²æŸ“èˆ‡ç‰©ç†
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      const speed = 5 * delta;
      if (move.forward) controls.moveForward(speed);
      if (move.backward) controls.moveForward(-speed);
      if (move.left) controls.moveRight(-speed);
      if (move.right) controls.moveRight(speed);
      if (move.jump && isOnGround) {
        velocity.y = 5;
        isOnGround = false;
      }
      velocity.y -= 9.8 * delta; // é‡åŠ›
      controls.getObject().position.y += velocity.y * delta;
      if (controls.getObject().position.y < 1) {
        controls.getObject().position.y = 1;
        velocity.y = 0;
        isOnGround = true;
      }
      renderer.render(scene, camera);
    }
    animate();

    // è‡ªé©æ‡‰çª—å£
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
