<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft 風格建造冒險</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            cursor: crosshair;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            pointer-events: none;
            width: 100%;
            height: 100%;
        }

        .panel {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            pointer-events: auto;
            font-size: 14px;
        }

        .hotbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #666;
        }

        .hotbar-slot {
            width: 48px;
            height: 48px;
            border: 2px solid #555;
            background: rgba(139, 69, 19, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            position: relative;
            transition: all 0.2s;
        }

        .hotbar-slot.selected {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .hotbar-slot .count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        .crosshair::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: white;
            box-shadow: 0 0 4px black;
        }

        .crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 2px;
            background: white;
            box-shadow: 0 0 4px black;
        }

        .stats {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: auto;
        }

        .health-bar {
            display: flex;
            gap: 2px;
            margin: 5px 0;
        }

        .heart {
            font-size: 16px;
            color: #ff4444;
        }

        .heart.empty {
            color: #444;
        }

        .shop-ui {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 69, 19, 0.95);
            border: 4px solid #8B4513;
            border-radius: 12px;
            padding: 30px;
            color: white;
            display: none;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            pointer-events: auto;
        }

        .shop-header {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-item:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .shop-item-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .shop-item-price {
            color: #FFD700;
            font-size: 14px;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: auto;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 1000;
        }

        .weapon-swing {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .block-outline {
            border: 2px solid white !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="loading" id="loading">
            🎮 載入 Minecraft 世界中...<br>
            <small>請稍候</small>
        </div>
        
        <div id="ui" style="display: none;">
            <div class="crosshair"></div>
            
            <div class="stats">
                <div><strong>🏃‍♂️ 玩家狀態</strong></div>
                <div class="health-bar" id="healthBar">
                    <span class="heart">❤️</span>
                    <span class="heart">❤️</span>
                    <span class="heart">❤️</span>
                    <span class="heart">❤️</span>
                    <span class="heart">❤️</span>
                </div>
                <div>💰 金幣: <span id="playerGold">0</span></div>
                <div>⭐ 等級: <span id="playerLevel">1</span></div>
                <div>📍 位置: <span id="playerPos">0, 0, 0</span></div>
            </div>

            <div class="controls">
                <div><strong>🎮 操作說明</strong></div>
                <div>WASD - 移動 (走路)</div>
                <div>空白鍵 - 跳躍</div>
                <div>滑鼠 - 轉動視角</div>
                <div>左鍵 - 攻擊/破壞</div>
                <div>右鍵 - 放置方塊</div>
                <div>右鍵連點2次 - 快速破壞</div>
                <div>1-9 - 選擇物品</div>
                <div>E - 與NPC互動</div>
                <div>Shift - 潛行</div>
            </div>
        </div>

        <div class="hotbar">
            <div class="hotbar-slot selected" data-slot="0">
                🧱
                <span class="count">64</span>
            </div>
            <div class="hotbar-slot" data-slot="1">
                🌳
                <span class="count">0</span>
            </div>
            <div class="hotbar-slot" data-slot="2">
                🪨
                <span class="count">0</span>
            </div>
            <div class="hotbar-slot" data-slot="3">
                ⛏️
                <span class="count">1</span>
            </div>
            <div class="hotbar-slot" data-slot="4">
                ⚔️
                <span class="count">1</span>
            </div>
            <div class="hotbar-slot" data-slot="5">
                🏹
                <span class="count">0</span>
            </div>
            <div class="hotbar-slot" data-slot="6">
                🍖
                <span class="count">3</span>
            </div>
            <div class="hotbar-slot" data-slot="7">
                💎
                <span class="count">0</span>
            </div>
            <div class="hotbar-slot" data-slot="8">
                🔥
                <span class="count">0</span>
            </div>
        </div>

        <div class="shop-ui" id="shopUI">
            <div class="shop-header">🏪 村莊商店</div>
            <div class="shop-grid" id="shopGrid">
                <div class="shop-item" data-item="iron_sword" data-price="50">
                    <div class="shop-item-icon">🗡️</div>
                    <div class="shop-item-name">鐵劍</div>
                    <div class="shop-item-price">💰 50 金幣</div>
                </div>
                <div class="shop-item" data-item="diamond_pickaxe" data-price="100">
                    <div class="shop-item-icon">⛏️</div>
                    <div class="shop-item-name">鑽石鎬</div>
                    <div class="shop-item-price">💰 100 金幣</div>
                </div>
                <div class="shop-item" data-item="bow" data-price="75">
                    <div class="shop-item-icon">🏹</div>
                    <div class="shop-item-name">弓箭</div>
                    <div class="shop-item-price">💰 75 金幣</div>
                </div>
                <div class="shop-item" data-item="armor" data-price="150">
                    <div class="shop-item-icon">🛡️</div>
                    <div class="shop-item-name">鐵盔甲</div>
                    <div class="shop-item-price">💰 150 金幣</div>
                </div>
                <div class="shop-item" data-item="food" data-price="10">
                    <div class="shop-item-icon">🍞</div>
                    <div class="shop-item-name">麵包</div>
                    <div class="shop-item-price">💰 10 金幣</div>
                </div>
                <div class="shop-item" data-item="blocks" data-price="5">
                    <div class="shop-item-icon">🧱</div>
                    <div class="shop-item-name">石磚 x10</div>
                    <div class="shop-item-price">💰 5 金幣</div>
                </div>
            </div>
            <button onclick="closeShop()" style="margin-top: 20px; padding: 10px 20px; background: #8B4513; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">關閉商店</button>
        </div>

        <div class="weapon-swing" id="weaponSwing">⚔️</div>
    </div>

    <script>
        // 遊戲狀態
        const gameState = {
            scene: null,
            camera: null,
            renderer: null,
            player: null,
            world: [],
            blocks: new Map(),
            npcs: [],
            village: null,
            inventory: [64, 0, 0, 1, 1, 0, 3, 0, 0], // 物品數量
            selectedSlot: 0,
            playerStats: {
                health: 100,
                maxHealth: 100,
                level: 1,
                gold: 0,
                attack: 10
            },
            worldSize: 100,
            chunkSize: 16,
            loadedChunks: new Set(),
            keys: {},
            mouse: { x: 0, y: 0, locked: false },
            camera: {
                rotation: { x: 0, y: 0 },
                distance: 0
            },
            controls: {
                moveSpeed: 0.15,
                jumpForce: 0.2,
                mouseSensitivity: 0.002
            },
            rightClickCount: 0,
            rightClickTimer: null,
            weaponCooldown: 0,
            isNearShop: false,
            highlightedBlock: null
        };

        // 方塊類型
        const BlockType = {
            AIR: 0,
            GRASS: 1,
            DIRT: 2,
            STONE: 3,
            WOOD: 4,
            LEAVES: 5,
            SAND: 6,
            WATER: 7,
            COBBLESTONE: 8,
            PLANKS: 9
        };

        const blockTextures = {
            [BlockType.GRASS]: { color: 0x7CB342, name: '草地' },
            [BlockType.DIRT]: { color: 0x8D6E63, name: '泥土' },
            [BlockType.STONE]: { color: 0x757575, name: '石頭' },
            [BlockType.WOOD]: { color: 0x8D6E63, name: '木頭' },
            [BlockType.LEAVES]: { color: 0x4CAF50, name: '樹葉' },
            [BlockType.SAND]: { color: 0xFFC107, name: '沙子' },
            [BlockType.WATER]: { color: 0x2196F3, name: '水' },
            [BlockType.COBBLESTONE]: { color: 0x616161, name: '圓石' },
            [BlockType.PLANKS]: { color: 0xA1887F, name: '木板' }
        };

        // 噪聲函數
        function noise(x, z) {
            let value = 0;
            let amplitude = 1;
            let frequency = 0.01;
            
            for (let i = 0; i < 4; i++) {
                value += Math.sin(x * frequency) * Math.cos(z * frequency) * amplitude;
                amplitude *= 0.5;
                frequency *= 2;
            }
            
            return value;
        }

        // 地形生成
        function getHeight(x, z) {
            const baseHeight = 32;
            const heightVariation = noise(x, z) * 8;
            return Math.floor(baseHeight + heightVariation);
        }

        function getBlockType(x, y, z) {
            const height = getHeight(x, z);
            
            if (y > height) return BlockType.AIR;
            if (y === height) return BlockType.GRASS;
            if (y > height - 3) return BlockType.DIRT;
            if (y > height - 10) return BlockType.STONE;
            return BlockType.STONE;
        }

        // 初始化遊戲
        function initGame() {
            console.log('🎮 初始化 Minecraft 世界...');
            
            try {
                setupThreeJS();
                setupLighting();
                setupCamera();
                setupControls();
                generateWorld();
                createPlayer();
                createVillage();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                
                startGameLoop();
                updateUI();
                
                console.log('✅ 遊戲初始化完成！');
                
            } catch (error) {
                console.error('❌ 遊戲初始化失敗:', error);
                document.getElementById('loading').innerHTML = `❌ 載入失敗<br><small>${error.message}</small>`;
            }
        }

        function setupThreeJS() {
            const canvas = document.getElementById('gameCanvas');
            
            gameState.scene = new THREE.Scene();
            gameState.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            gameState.renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: false // 關閉抗鋸齒提升性能
            });
            
            gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            gameState.renderer.setClearColor(0x87CEEB); // 天空藍
            gameState.renderer.shadowMap.enabled = true;
            gameState.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            gameState.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // 設置霧效果
            gameState.scene.fog = new THREE.Fog(0x87CEEB, 50, 200);
        }

        function setupLighting() {
            // 環境光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            gameState.scene.add(ambientLight);

            // 太陽光
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 50);
            directionalLight.castShadow = true;
            
            // 陰影設置
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            
            gameState.scene.add(directionalLight);
        }

        function setupCamera() {
            gameState.camera.position.set(0, 35, 0);
            gameState.camera.rotation.order = 'YXZ';
        }

        function setupControls() {
            // 鍵盤事件
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.code] = true;
                
                // 數字鍵選擇物品
                if (e.code >= 'Digit1' && e.code <= 'Digit9') {
                    const slot = parseInt(e.code.replace('Digit', '')) - 1;
                    selectSlot(slot);
                }
                
                // E鍵與NPC互動
                if (e.code === 'KeyE' && gameState.isNearShop) {
                    toggleShop();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                gameState.keys[e.code] = false;
            });
            
            // 滑鼠事件
            document.addEventListener('mousedown', (e) => {
                if (!gameState.mouse.locked) {
                    canvas.requestPointerLock();
                    return;
                }
                
                if (e.button === 0) { // 左鍵
                    handleLeftClick();
                } else if (e.button === 2) { // 右鍵
                    handleRightClick();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!gameState.mouse.locked) return;
                
                const movementX = e.movementX || 0;
                const movementY = e.movementY || 0;
                
                gameState.camera.rotation.y -= movementX * gameState.controls.mouseSensitivity;
                gameState.camera.rotation.x -= movementY * gameState.controls.mouseSensitivity;
                
                // 限制上下視角
                gameState.camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, gameState.camera.rotation.x));
            });
            
            // 滑鼠鎖定事件
            document.addEventListener('pointerlockchange', () => {
                gameState.mouse.locked = document.pointerLockElement === document.getElementById('gameCanvas');
            });
            
            document.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // 視窗大小調整
            window.addEventListener('resize', () => {
                gameState.camera.aspect = window.innerWidth / window.innerHeight;
                gameState.camera.updateProjectionMatrix();
                gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function generateWorld() {
            console.log('🌍 生成世界地形...');
            
            // 生成初始區塊
            for (let chunkX = -2; chunkX <= 2; chunkX++) {
                for (let chunkZ = -2; chunkZ <= 2; chunkZ++) {
                    generateChunk(chunkX, chunkZ);
                }
            }
        }

        function generateChunk(chunkX, chunkZ) {
            const chunkKey = `${chunkX},${chunkZ}`;
            if (gameState.loadedChunks.has(chunkKey)) return;
            
            gameState.loadedChunks.add(chunkKey);
            
            const startX = chunkX * gameState.chunkSize;
            const startZ = chunkZ * gameState.chunkSize;
            
            for (let x = startX; x < startX + gameState.chunkSize; x++) {
                for (let z = startZ; z < startZ + gameState.chunkSize; z++) {
                    const height = getHeight(x, z);
                    
                    // 生成地面
                    for (let y = 0; y <= height; y++) {
                        const blockType = getBlockType(x, y, z);
                        if (blockType !== BlockType.AIR) {
                            createBlock(x, y, z, blockType);
                        }
                    }
                    
                    // 生成樹木
                    if (Math.random() < 0.02 && height > 30) {
                        generateTree(x, height + 1, z);
                    }
                }
            }
        }

        function generateTree(x, y, z) {
            // 樹幹
            for (let i = 0; i < 4; i++) {
                createBlock(x, y + i, z, BlockType.WOOD);
            }
            
            // 樹葉
            for (let dx = -2; dx <= 2; dx++) {
                for (let dz = -2; dz <= 2; dz++) {
                    for (let dy = 3; dy <= 5; dy++) {
                        if (Math.abs(dx) + Math.abs(dz) <= 2 + Math.random()) {
                            createBlock(x + dx, y + dy, z + dz, BlockType.LEAVES);
                        }
                    }
                }
            }
        }

        function createVillage() {
            console.log('🏘️ 生成村莊...');
            
            const villageX = 20;
            const villageZ = 20;
            const villageSize = 10;
            
            // 平整地面
            for (let x = villageX - villageSize; x <= villageX + villageSize; x++) {
                for (let z = villageZ - villageSize; z <= villageZ + villageSize; z++) {
                    const height = getHeight(x, z);
                    
                    // 清除現有方塊
                    for (let y = height + 1; y <= height + 10; y++) {
                        removeBlock(x, y, z);
                    }
                    
                    // 鋪設地面
                    createBlock(x, height, z, BlockType.COBBLESTONE);
                }
            }
            
            // 建造房屋
            buildHouse(villageX - 5, getHeight(villageX - 5, villageZ - 5) + 1, villageZ - 5);
            buildHouse(villageX + 5, getHeight(villageX + 5, villageZ - 5) + 1, villageZ - 5);
            buildHouse(villageX - 5, getHeight(villageX - 5, villageZ + 5) + 1, villageZ + 5);
            
            // 建造商店
            buildShop(villageX, getHeight(villageX, villageZ) + 1, villageZ);
            
            // 創建商店NPC
            createShopNPC(villageX, getHeight(villageX, villageZ) + 2, villageZ);
        }

        function buildHouse(x, y, z) {
            // 牆壁
            for (let dx = -2; dx <= 2; dx++) {
                for (let dz = -2; dz <= 2; dz++) {
                    for (let dy = 0; dy <= 3; dy++) {
                        if (dx === -2 || dx === 2 || dz === -2 || dz === 2) {
                            if (dy === 0 || dy === 3 || (dx !== 0 && dz !== 0)) {
                                createBlock(x + dx, y + dy, z + dz, BlockType.PLANKS);
                            }
                        }
                    }
                }
            }
            
            // 屋頂
            for (let dx = -3; dx <= 3; dx++) {
                for (let dz = -3; dz <= 3; dz++) {
                    if (Math.abs(dx) + Math.abs(dz) <= 4) {
                        createBlock(x + dx, y + 4, z + dz, BlockType.WOOD);
                    }
                }
            }
        }

        function buildShop(x, y, z) {
            // 較大的商店建築
            for (let dx = -3; dx <= 3; dx++) {
                for (let dz = -3; dz <= 3; dz++) {
                    for (let dy = 0; dy <= 4; dy++) {
                        if (dx === -3 || dx === 3 || dz === -3 || dz === 3) {
                            createBlock(x + dx, y + dy, z + dz, BlockType.COBBLESTONE);
                        }
                    }
                }
            }
            
            // 屋頂
            for (let dx = -4; dx <= 4; dx++) {
                for (let dz = -4; dz <= 4; dz++) {
                    if (Math.abs(dx) + Math.abs(dz) <= 6) {
                        createBlock(x + dx, y + 5, z + dz, BlockType.WOOD);
                    }
                }
            }
            
            // 門口
            removeBlock(x, y + 1, z - 3);
            removeBlock(x, y + 2, z - 3);
        }

        function createShopNPC(x, y, z) {
            const geometry = new THREE.BoxGeometry(0.8, 1.8, 0.8);
            const material = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const npc = new THREE.Mesh(geometry, material);
            
            npc.position.set(x, y, z);
            npc.userData = { type: 'shop', interactRange: 5 };
            npc.castShadow = true;
            
            // NPC頭部
            const headGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFFDBB5 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.set(0, 1.2, 0);
            npc.add(head);
            
            gameState.scene.add(npc);
            gameState.npcs.push(npc);
            
            console.log('🧑‍💼 商店NPC已創建');
        }

        function createBlock(x, y, z, type) {
            const key = `${x},${y},${z}`;
            if (gameState.blocks.has(key)) return;
            
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshLambertMaterial({ 
                color: blockTextures[type].color
            });
            
            const block = new THREE.Mesh(geometry, material);
            block.position.set(x, y, z);
            block.userData = { 
                type: type, 
                x: x, 
                y: y, 
                z: z,
                blockKey: key
            };
            
            block.castShadow = true;
            block.receiveShadow = true;
            
            gameState.scene.add(block);
            gameState.blocks.set(key, block);
            gameState.world.push(block);
        }

        function removeBlock(x, y, z) {
            const key = `${x},${y},${z}`;
            const block = gameState.blocks.get(key);
            
            if (block) {
                gameState.scene.remove(block);
                gameState.blocks.delete(key);
                gameState.world = gameState.world.filter(b => b !== block);
                
                // 給予資源
                const blockType = block.userData.type;
                if (blockType === BlockType.WOOD) {
                    gameState.inventory[1]++;
                    gameState.playerStats.gold += 2;
                } else if (blockType === BlockType.STONE) {
                    gameState.inventory[2]++;
                    gameState.playerStats.gold += 1;
                } else if (blockType === BlockType.LEAVES) {
                    if (Math.random() < 0.1) {
                        gameState.inventory[1]++; // 有機會掉落木頭
                    }
                }
                
                updateUI();
                return true;
            }
            return false;
        }

        function createPlayer() {
            console.log('👤 創建玩家...');
            
            const group = new THREE.Group();
            
            // 身體
            const bodyGeometry = new THREE.BoxGeometry(0.6, 1.2, 0.3);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x4CAF50 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.6;
            group.add(body);
            
            // 頭部
            const headGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFFDBB5 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.5;
            group.add(head);
            
            // 手臂
            const armGeometry = new THREE.BoxGeometry(0.2, 1, 0.2);
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0xFFDBB5 });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.5, 0.5, 0);
            group.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.5, 0.5, 0);
            group.add(rightArm);
            
            // 腿
            const legGeometry = new THREE.BoxGeometry(0.2, 1, 0.2);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0x2196F3 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.2, -0.5, 0);
            group.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.2, -0.5, 0);
            group.add(rightLeg);
            
            // 設置初始位置
            const spawnHeight = getHeight(0, 0) + 3;
            group.position.set(0, spawnHeight, 0);
            group.userData = { 
                velocityY: 0,
                onGround: false,
                health: 100
            };
            
            group.castShadow = true;
            gameState.scene.add(group);
            gameState.player = group;
        }

        function getTargetedBlock() {
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), gameState.camera);
            
            const intersects = raycaster.intersectObjects(gameState.world);
            
            if (intersects.length > 0) {
                return {
                    block: intersects[0].object,
                    face: intersects[0].face,
                    point: intersects[0].point
                };
            }
            
            return null;
        }

        function highlightBlock() {
            // 清除之前的高亮
            if (gameState.highlightedBlock) {
                gameState.highlightedBlock.material.emissive.setHex(0x000000);
                gameState.highlightedBlock = null;
            }
            
            const target = getTargetedBlock();
            if (target) {
                gameState.highlightedBlock = target.block;
                target.block.material.emissive.setHex(0x444444);
            }
        }

        function handleLeftClick() {
            if (gameState.weaponCooldown > 0) return;
            
            // 揮劍動畫
            playWeaponSwing();
            gameState.weaponCooldown = 500; // 0.5秒冷卻
            
            const target = getTargetedBlock();
            if (target) {
                const block = target.block;
                const userData = block.userData;
                
                // 破壞方塊
                if (removeBlock(userData.x, userData.y, userData.z)) {
                    console.log(`🔨 破壞了 ${blockTextures[userData.type].name}`);
                }
            }
        }

        function handleRightClick() {
            gameState.rightClickCount++;
            
            // 重置計時器
            clearTimeout(gameState.rightClickTimer);
            gameState.rightClickTimer = setTimeout(() => {
                if (gameState.rightClickCount === 1) {
                    // 單次右鍵 - 放置方塊
                    placeBlock();
                } else if (gameState.rightClickCount >= 2) {
                    // 雙擊右鍵 - 快速破壞
                    quickBreak();
                }
                gameState.rightClickCount = 0;
            }, 300);
        }

        function placeBlock() {
            if (gameState.inventory[gameState.selectedSlot] <= 0) return;
            
            const target = getTargetedBlock();
            if (!target) return;
            
            const face = target.face;
            const block = target.block;
            const pos = block.position.clone();
            
            // 根據面的法向量決定新方塊位置
            pos.add(face.normal);
            
            // 檢查位置是否被玩家占用
            const playerPos = gameState.player.position;
            const distance = pos.distanceTo(playerPos);
            if (distance < 1.5) return; // 太靠近玩家
            
            // 檢查位置是否已被占用
            const key = `${Math.round(pos.x)},${Math.round(pos.y)},${Math.round(pos.z)}`;
            if (gameState.blocks.has(key)) return;
            
            // 放置方塊
            const blockType = getSelectedBlockType();
            if (blockType !== null) {
                createBlock(Math.round(pos.x), Math.round(pos.y), Math.round(pos.z), blockType);
                gameState.inventory[gameState.selectedSlot]--;
                updateUI();
                console.log(`🧱 放置了 ${blockTextures[blockType].name}`);
            }
        }

        function quickBreak() {
            const target = getTargetedBlock();
            if (target) {
                const block = target.block;
                const userData = block.userData;
                
                if (removeBlock(userData.x, userData.y, userData.z)) {
                    console.log(`💥 快速破壞了 ${blockTextures[userData.type].name}`);
                }
            }
        }

        function getSelectedBlockType() {
            switch (gameState.selectedSlot) {
                case 0: return BlockType.COBBLESTONE;
                case 1: return BlockType.WOOD;
                case 2: return BlockType.STONE;
                default: return null;
            }
        }

        function playWeaponSwing() {
            const weaponSwing = document.getElementById('weaponSwing');
            const selectedItem = gameState.inventory[gameState.selectedSlot];
            
            let weaponIcon = '✊';
            if (gameState.selectedSlot === 3) weaponIcon = '⛏️';
            else if (gameState.selectedSlot === 4) weaponIcon = '⚔️';
            else if (gameState.selectedSlot === 5) weaponIcon = '🏹';
            
            weaponSwing.textContent = weaponIcon;
            weaponSwing.style.opacity = '1';
            weaponSwing.style.transform = 'translate(-50%, -50%) rotate(-45deg) scale(1.2)';
            
            setTimeout(() => {
                weaponSwing.style.opacity = '0';
                weaponSwing.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1)';
            }, 200);
        }

        function updatePlayer() {
            if (!gameState.player) return;
            
            const moveSpeed = gameState.controls.moveSpeed;
            const jumpForce = gameState.controls.jumpForce;
            
            const playerPos = gameState.player.position;
            const newPos = playerPos.clone();
            
            // 移動向量
            const moveVector = new THREE.Vector3();
            
            // 根據相機方向計算移動
            if (gameState.keys['KeyW']) moveVector.z -= 1;
            if (gameState.keys['KeyS']) moveVector.z += 1;
            if (gameState.keys['KeyA']) moveVector.x -= 1;
            if (gameState.keys['KeyD']) moveVector.x += 1;
            
            // 正規化移動向量
            if (moveVector.length() > 0) {
                moveVector.normalize();
                
                // 根據相機Y軸旋轉調整移動方向
                moveVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), gameState.camera.rotation.y);
                
                // 潛行時移動較慢
                const actualMoveSpeed = gameState.keys['ShiftLeft'] ? moveSpeed * 0.5 : moveSpeed;
                newPos.add(moveVector.multiplyScalar(actualMoveSpeed));
            }
            
            // 跳躍
            if (gameState.keys['Space'] && gameState.player.userData.onGround) {
                gameState.player.userData.velocityY = jumpForce;
                gameState.player.userData.onGround = false;
            }
            
            // 重力
            gameState.player.userData.velocityY -= 0.01;
            newPos.y += gameState.player.userData.velocityY;
            
            // 地面碰撞檢測
            const groundHeight = getGroundHeight(newPos.x, newPos.z) + 1.5;
            if (newPos.y <= groundHeight) {
                newPos.y = groundHeight;
                gameState.player.userData.velocityY = 0;
                gameState.player.userData.onGround = true;
            } else {
                gameState.player.userData.onGround = false;
            }
            
            // 邊界檢測
            const boundary = gameState.worldSize / 2;
            newPos.x = Math.max(-boundary, Math.min(boundary, newPos.x));
            newPos.z = Math.max(-boundary, Math.min(boundary, newPos.z));
            
            gameState.player.position.copy(newPos);
            
            // 檢查是否靠近商店
            checkNearShop();
        }

        function getGroundHeight(x, z) {
            let maxHeight = 0;
            
            // 檢查玩家腳下的方塊
            for (let dx = -1; dx <= 1; dx++) {
                for (let dz = -1; dz <= 1; dz++) {
                    const checkX = Math.floor(x + dx);
                    const checkZ = Math.floor(z + dz);
                    
                    for (let y = 60; y >= 0; y--) {
                        const key = `${checkX},${y},${checkZ}`;
                        if (gameState.blocks.has(key)) {
                            maxHeight = Math.max(maxHeight, y);
                            break;
                        }
                    }
                }
            }
            
            return maxHeight;
        }

        function checkNearShop() {
            let nearShop = false;
            
            gameState.npcs.forEach(npc => {
                if (npc.userData.type === 'shop') {
                    const distance = gameState.player.position.distanceTo(npc.position);
                    if (distance < npc.userData.interactRange) {
                        nearShop = true;
                    }
                }
            });
            
            if (nearShop !== gameState.isNearShop) {
                gameState.isNearShop = nearShop;
                if (nearShop) {
                    showMessage('按 E 鍵與商店NPC互動');
                }
            }
        }

        function updateCamera() {
            if (!gameState.player) return;
            
            const playerPos = gameState.player.position;
            
            // 第一人稱視角
            gameState.camera.position.copy(playerPos);
            gameState.camera.position.y += 1.6; // 眼睛高度
            
            // 應用旋轉
            gameState.camera.rotation.x = gameState.camera.rotation.x;
            gameState.camera.rotation.y = gameState.camera.rotation.y;
        }

        function startGameLoop() {
            function gameLoop() {
                requestAnimationFrame(gameLoop);
                
                // 更新武器冷卻
                if (gameState.weaponCooldown > 0) {
                    gameState.weaponCooldown -= 16; // 假設60FPS
                }
                
                updatePlayer();
                updateCamera();
                highlightBlock();
                
                // 動態載入區塊
                loadNearbyChunks();
                
                gameState.renderer.render(gameState.scene, gameState.camera);
            }
            
            gameLoop();
        }

        function loadNearbyChunks() {
            if (!gameState.player) return;
            
            const playerPos = gameState.player.position;
            const chunkX = Math.floor(playerPos.x / gameState.chunkSize);
            const chunkZ = Math.floor(playerPos.z / gameState.chunkSize);
            
            const loadDistance = 3;
            
            for (let x = chunkX - loadDistance; x <= chunkX + loadDistance; x++) {
                for (let z = chunkZ - loadDistance; z <= chunkZ + loadDistance; z++) {
                    generateChunk(x, z);
                }
            }
        }

        function selectSlot(slot) {
            if (slot < 0 || slot >= gameState.inventory.length) return;
            
            document.querySelector('.hotbar-slot.selected')?.classList.remove('selected');
            document.querySelector(`[data-slot="${slot}"]`)?.classList.add('selected');
            gameState.selectedSlot = slot;
            
            console.log(`📦 選擇物品槽 ${slot + 1}`);
        }

        function updateUI() {
            // 更新背包
            const hotbarSlots = document.querySelectorAll('.hotbar-slot');
            hotbarSlots.forEach((slot, index) => {
                const count = slot.querySelector('.count');
                if (count) {
                    count.textContent = gameState.inventory[index] || 0;
                }
            });
            
            // 更新統計
            document.getElementById('playerGold').textContent = gameState.playerStats.gold;
            document.getElementById('playerLevel').textContent = gameState.playerStats.level;
            
            // 更新位置
            if (gameState.player) {
                const pos = gameState.player.position;
                document.getElementById('playerPos').textContent = 
                    `${Math.floor(pos.x)}, ${Math.floor(pos.y)}, ${Math.floor(pos.z)}`;
            }
            
            // 更新血量
            updateHealthBar();
        }

        function updateHealthBar() {
            const hearts = document.querySelectorAll('.heart');
            const maxHearts = hearts.length;
            const healthPerHeart = gameState.playerStats.maxHealth / maxHearts;
            const fullHearts = Math.floor(gameState.playerStats.health / healthPerHeart);
            
            hearts.forEach((heart, index) => {
                heart.classList.toggle('empty', index >= fullHearts);
            });
        }

        function showMessage(text) {
            // 簡單的訊息顯示
            const existingMsg = document.querySelector('.game-message');
            if (existingMsg) existingMsg.remove();
            
            const message = document.createElement('div');
            message.className = 'game-message';
            message.style.cssText = `
                position: fixed;
                top: 70%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-size: 16px;
                z-index: 1000;
                pointer-events: none;
            `;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 3000);
        }

        // 商店系統
        function toggleShop() {
            const shopUI = document.getElementById('shopUI');
            const isVisible = shopUI.style.display !== 'none';
            shopUI.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.exitPointerLock();
                gameState.mouse.locked = false;
            }
        }

        function closeShop() {
            document.getElementById('shopUI').style.display = 'none';
        }

        // 商店物品購買
        document.addEventListener('click', (e) => {
            const shopItem = e.target.closest('.shop-item');
            if (shopItem) {
                const itemType = shopItem.dataset.item;
                const price = parseInt(shopItem.dataset.price);
                buyItem(itemType, price);
            }
        });

        function buyItem(itemType, price) {
            if (gameState.playerStats.gold < price) {
                showMessage(`💰 金幣不足！需要 ${price} 金幣`);
                return;
            }
            
            gameState.playerStats.gold -= price;
            
            switch (itemType) {
                case 'iron_sword':
                    gameState.inventory[4]++;
                    gameState.playerStats.attack += 5;
                    showMessage('🗡️ 購買了鐵劍！攻擊力提升！');
                    break;
                case 'diamond_pickaxe':
                    gameState.inventory[3]++;
                    showMessage('⛏️ 購買了鑽石鎬！');
                    break;
                case 'bow':
                    gameState.inventory[5]++;
                    showMessage('🏹 購買了弓箭！');
                    break;
                case 'armor':
                    gameState.playerStats.maxHealth += 20;
                    gameState.playerStats.health = gameState.playerStats.maxHealth;
                    showMessage('🛡️ 購買了盔甲！血量提升！');
                    break;
                case 'food':
                    gameState.inventory[6] += 5;
                    showMessage('🍞 購買了麵包！');
                    break;
                case 'blocks':
                    gameState.inventory[0] += 10;
                    showMessage('🧱 購買了石磚！');
                    break;
            }
            
            updateUI();
        }

        // 遊戲啟動
        function startGame() {
            if (typeof THREE === 'undefined') {
                console.error('Three.js 未載入');
                document.getElementById('loading').innerHTML = '❌ Three.js 載入失敗';
                return;
            }
            
            console.log('✅ Three.js 載入成功');
            
            setTimeout(() => {
                try {
                    initGame();
                } catch (error) {
                    console.error('❌ 遊戲初始化錯誤:', error);
                    document.getElementById('loading').innerHTML = `❌ 載入失敗<br><small>${error.message}</small>`;
                }
            }, 100);
        }

        // 頁面載入完成後啟動遊戲
        window.addEventListener('load', startGame);
        
        if (document.readyState === 'complete') {
            startGame();
        }
    </script>
</body>
</html>
